name: ci

on:
    push:
        paths-ignore:
            - 'README.md'
            - 'RELEASE.md'
            - 'CONTRIBUTING.md'
    pull_request:

jobs:
    build:
        runs-on: windows-latest

        steps:
            - name: Checkout 🛎️
              uses: actions/checkout@v2
              with:
                  # https://github.com/adamralph/minver#why-is-the-default-version-sometimes-used-in-github-actions-and-travis-ci-when-a-version-tag-exists-in-the-history
                  fetch-depth: 5

            - name: Install .NET 6.0 🧳
              uses: actions/setup-dotnet@v1
              with:
                  dotnet-version: '6.0.x'

            - name: Install dependencies 🔌
              run: dotnet restore src

            - name: Build project 🏗
              run: dotnet build src -c Release --no-restore

            - name: Test 🚨
              run: dotnet run --project src/Tests

            - name: Publish 🚀
              if: github.event_name == 'push'
              run: |
                  if ( "${{github.ref}}" -match "^refs/tags/[0-9]+\.[0-9]+\.[0-9]+" ) {
                      dotnet tool install --global dotnet-releaser --version "0.1.*"
                      dotnet-releaser publish --github-token ${{secrets.TOKEN_GITHUB}} src/dotnet-releaser.toml
                  } else {
                      echo "publish is only enabled by tagging with a release tag"
                  }
